
<!-- sprite-select (character selection, story-aware) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Character Selection</title>
  <link rel="stylesheet" href="css/sprite-style.css">
</head>
<body>
  <h2>Select your Character!</h2>

  <div class="scene-wrapper" id="characters">
    <!-- Story background -->
    <img id="scene" alt="Scene">
    <!-- Characters injected by JS -->
  </div>

  <!-- Guard: must have story & grade -->
  <script type="module">
    import { readCtx, nextURL } from './js/flow.js';
    const ctx = readCtx();
    if (!ctx.story) location.replace(nextURL('story-select.html', ctx));
    if (!ctx.grade) location.replace(nextURL('grade-select.html', ctx));
  </script>

  <!-- Runtime: load manifest & characters -->
  <script type="module">
    import { readCtx } from './js/flow.js';
    import { getGradeCaps } from './js/grad-config.js';

    const ctx = readCtx();
    const container = document.getElementById('characters');
    const sceneImg  = document.getElementById('scene');
    const storyId   = ctx.story; // e.g. "tortoise-hare"

    // Fetch characters.json for this story
    async function loadManifest() {
      const url = `stories/${storyId}/characters.json`;
      try {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(res.statusText);
        return await res.json();
      } catch (err) {
        console.warn('No characters.json for', storyId, err);
        return { background:'', characters:[] };
      }
    }

    // Background helper (try manifest → fallback)
    function setBackground(paths) {
      const [first, ...rest] = paths;
      if (!first) return;
      sceneImg.src = first;
      sceneImg.onerror = () => setBackground(rest);
    }

    (async () => {
      const manifest = await loadManifest();

      // Put background in place
      setBackground([
        manifest.background,
        `images/backgrounds/${storyId}/select-scene.png`,
        'images/backgrounds/tortoise-hare/frame5.png'
      ].filter(Boolean));

      // Grade filter
      let allowed = new Set();
      try {
        const caps = await getGradeCaps(ctx.grade || 'k-2');
        if (caps?.allowedCharacters?.length) {
          allowed = new Set(caps.allowedCharacters);
        }
      } catch {}

      // Inject characters
      const frag = document.createDocumentFragment();
      let count = 0;

      for (const c of manifest.characters || []) {
        if (allowed.size && !allowed.has(c.id)) continue;

        const img = document.createElement('img');
        img.className    = `character ${c.id}`;
        img.dataset.char = c.id;
        img.alt          = c.name || c.id;
        img.draggable    = false;
        img.src          = c.sprite || `images/${c.id}.png`;

        // Position overrides (optional, percent-based)
        if (typeof c.x === 'number') img.style.left   = `${c.x}%`;
        if (typeof c.y === 'number') img.style.top    = `${c.y}%`;
        if (typeof c.w === 'number') img.style.width  = `${c.w}%`;
        if (typeof c.z === 'number') img.style.zIndex = String(c.z);

        frag.appendChild(img);
        count++;
      }

      container.appendChild(frag);

      if (!count) console.warn('No characters rendered — check manifest or grade caps.');

      // Attach selection logic *after* characters exist
      try { await import('./js/azure-api.js'); } catch {}
      await import('./js/sprite-select.js');
    })();
  </script>
</body>
</html>
