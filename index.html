
<!-- character-select (story-aware) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Character Selection</title>
  <link rel="stylesheet" href="css/sprite-style.css">
</head>
<body>
  <h2>Select your Character!</h2>

  <div class="scene-wrapper" id="characters">
    <!-- Background swaps per story -->
    <img id="scene" alt="Scene">
    <!-- Story characters get injected here -->
  </div>

  <!-- Route guard: need story & grade -->
  <script type="module">
    import { readCtx, nextURL } from './js/flow.js';
    const ctx = readCtx();
    if (!ctx.story) location.replace(nextURL('story-select.html', ctx));
    if (!ctx.grade) location.replace(nextURL('grade-select.html', ctx));
  </script>

  <!-- Load story manifest, render characters, then attach selection logic -->
  <script type="module">
    import { readCtx } from './js/flow.js';
    import { getGradeCaps } from './js/grade-config.js';

    const ctx = readCtx();
    const container = document.getElementById('characters');
    const sceneImg  = document.getElementById('scene');

    // Map dashed ids to underscored folders (both supported)
    const STORY_DIR = new Map([
      ['tortoise-hare', 'tortoise_and_the_hare'],
      ['lion-mouse',    'lion_and_mouse'],
    ]);
    const storyId  = ctx.story;                         // e.g. "tortoise-hare"
    const storyDir = STORY_DIR.get(storyId) || storyId; // e.g. "tortoise_and_the_hare"

    // Helper: try multiple URLs until one loads
    async function fetchJSONTry(urls){
      for (const u of urls){
        try {
          const r = await fetch(u, { cache: 'no-store' });
          if (r.ok) return await r.json();
        } catch {}
        console.warn('Missing manifest:', u);
      }
      return null;
    }

    // 1) Load this story’s character-select manifest
    //    Tries: stories/<id>/characters.json, stories/<folder>/characters.json
    const manifest =
      await fetchJSONTry([
        `stories/${storyId}/characters.json`,
        `stories/${storyDir}/characters.json`,
      ]) || { background:'', characters:[] };

    // 2) Put the story background in place (with fallbacks)
    const bgFallbacks = [
      manifest.background,
      `images/backgrounds/${storyDir}/select-scene.png`,
      `images/backgrounds/${storyId}/select-scene.png`,
      'images/backgrounds/tortoise-hare/frame5.png'
    ].filter(Boolean);

    function setBackground(urls){
      const [first, ...rest] = urls;
      if (!first) return;
      sceneImg.src = first;
      sceneImg.onload = () => {};
      sceneImg.onerror = () => setBackground(rest);
    }
    setBackground(bgFallbacks);

    // 3) Grade filtering (optional caps); empty set = no filter
    let allowed = new Set();
    try {
      const caps = await getGradeCaps(ctx.grade || 'k-2');
      if (caps?.allowedCharacters?.length) {
        allowed = new Set(caps.allowedCharacters);
      }
    } catch {}

    // 4) Insert story’s characters (keep your CSS classes for positioning)
    const frag = document.createDocumentFragment();
    const list = Array.isArray(manifest.characters) ? manifest.characters : [];

    let rendered = 0;
    for (const c of list){
      if (allowed.size && !allowed.has(c.id)) continue;

      const img = document.createElement('img');
      img.className     = `character ${c.id}`; // preserves sprite-style.css placement
      img.dataset.char  = c.id;
      img.alt           = c.name || c.id;
      img.draggable     = false;

      // default sprite path if not provided
      img.src = c.sprite || `images/${c.id}.png`;

      // Optional per-story overrides (percent-based for left/top/width)
      if (typeof c.x === 'number') img.style.left  = `${c.x}%`;
      if (typeof c.y === 'number') img.style.top   = `${c.y}%`;
      if (typeof c.w === 'number') img.style.width = `${c.w}%`;
      if (typeof c.z === 'number') img.style.zIndex = String(c.z);

      frag.appendChild(img);
      rendered++;
    }
    container.appendChild(frag);

    if (!rendered) {
      console.warn('No characters rendered. Check characters.json and grade caps.');
    }

    // 5) After characters exist, attach your existing selection logic
    try { await import('./js/azure-api.js'); } catch {}
    await import('./js/sprite-select.js');
  </script>
</body>
</html>
